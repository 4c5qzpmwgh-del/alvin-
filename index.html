<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alvin記帳 v9.0 (全功能版)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* === 核心樣式設定 === */
        :root {
            --bg-color: #0f1115;
            --card-bg: #1c1e24;
            --text-main: #ffffff;
            --text-sub: #8a8f98;
            --accent-green: #34d399;
            --accent-red: #fb7185;
            --accent-blue: #60a5fa;
            --accent-purple: #a78bfa;
            --accent-cyan: #22d3ee;
            --accent-gold: #fbbf24;
            --input-bg: #2a2d36;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            padding-bottom: 90px;
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
        }

        /* === 導航列 === */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #1f2937; border-top: 1px solid #333;
            display: flex; justify-content: space-around; padding: 10px 0;
            z-index: 900; padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .nav-item {
            text-align: center; color: var(--text-sub); font-size: 9px;
            cursor: pointer; flex: 1; transition: color 0.3s;
        }
        .nav-item i { font-size: 18px; display: block; margin-bottom: 4px; }
        .nav-item.active { color: var(--accent-blue); }

        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* === 卡片與列表 === */
        .header-card {
            background: linear-gradient(180deg, #1e3a8a 0%, #0f1115 100%);
            padding: 25px 20px; border-bottom: 1px solid #333;
            position: sticky; top: 0; z-index: 100;
        }
        .header-title { color: rgba(255,255,255,0.7); font-size: 12px; letter-spacing: 2px; }
        .main-balance { font-size: 48px; font-weight: 700; margin: 10px 0; }
        
        .summary-grid { display: flex; gap: 10px; margin-top: 15px; }
        .summary-item { flex: 1; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; }
        .summary-label { font-size: 11px; color: rgba(255,255,255,0.7); }

        .record-list { margin: 0 20px; }
        .record-item { 
            background: var(--card-bg); padding: 15px; border-radius: 16px; 
            margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-title { margin: 20px 20px 10px; font-size: 13px; color: var(--text-sub); font-weight: bold; }

        /* 進度條樣式 */
        .progress-container { height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; background: var(--accent-blue); width: 0%; transition: width 0.5s; }

        /* 輸入框樣式 */
        .input-container { margin: 20px; background: var(--card-bg); border-radius: 20px; padding: 20px; }
        .amount-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid #444; color: white; font-size: 24px; margin-bottom: 15px; outline: none; }
        .custom-select, .text-input { width: 100%; background: var(--input-bg); color: white; border: 1px solid #444; padding: 12px; border-radius: 12px; margin-bottom: 15px; }
        .submit-btn { width: 100%; background: white; color: black; font-weight: bold; padding: 15px; border-radius: 12px; border: none; cursor: pointer; }

        /* 月曆樣式 */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding: 0 20px; }
        .cal-day { aspect-ratio: 1; background: var(--card-bg); border-radius: 8px; display: flex; flex-direction: column; align-items: center; font-size: 12px; padding-top: 5px; cursor: pointer; border: 1px solid transparent; }
        .cal-day.selected { border-color: white; background: rgba(255,255,255,0.1); }
        .cal-dots { display: flex; gap: 2px; margin-top: 4px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; }
        
        /* 彈窗樣式 */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 350px; padding: 20px; border-radius: 20px; }
        #statusMsg { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 24px; border-radius: 30px; opacity: 0; transition: 0.3s; z-index: 999; }
    </style>
</head>
<body>

    <div id="statusMsg">操作成功</div>

    <div id="authModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; text-align: center;">帳號登入</h3>
            <input type="email" id="authEmail" class="text-input" placeholder="Email">
            <input type="password" id="authPassword" class="text-input" placeholder="密碼">
            <button onclick="window.handleAuth('login')" class="submit-btn" style="margin-bottom: 10px;">登入</button>
            <button onclick="window.closeModal('authModal')" style="width:100%; background:none; border:none; color:#888;">取消</button>
        </div>
    </div>

    <div id="view-accounting" class="view-section active">
        <div class="header-card">
            <div style="display:flex; justify-content:space-between;">
                <span class="header-title">TOTAL BALANCE</span>
                <button onclick="window.openAuthModal()" class="icon-btn" id="userBtn" style="background:none; border:none; color:#888;"><i class="fa-solid fa-circle-user"></i></button>
            </div>
            <div style="display: flex; align-items: baseline;"><span style="font-size:24px;">$</span><span id="totalBalance" class="main-balance">0</span></div>
            <div class="summary-grid">
                <div class="summary-item"><div class="summary-label">本月收入</div><div id="totalIncome" style="color:var(--accent-green); font-weight:bold;">+0</div></div>
                <div class="summary-item"><div class="summary-label">本月支出</div><div id="totalExpense" style="color:var(--accent-red); font-weight:bold;">-0</div></div>
            </div>
        </div>

        <div class="input-container">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button onclick="window.setType('expense')" id="typeExp" style="flex:1; padding:10px; border-radius:10px; border:none; background:var(--accent-red); color:white;">支出</button>
                <button onclick="window.setType('income')" id="typeInc" style="flex:1; padding:10px; border-radius:10px; border:none; background:#333; color:white;">收入</button>
            </div>
            <input type="number" id="amountInput" placeholder="金額" class="amount-input">
            <select id="categoryInput" class="custom-select"></select>
            <input type="datetime-local" id="dateInput" class="text-input">
            <button onclick="window.addRecord()" class="submit-btn">確認記帳</button>
        </div>
        <div id="recordList" class="record-list"></div>
    </div>

    <div id="view-calendar" class="view-section">
        <div class="header-card" style="background:#1f2937">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button onclick="window.changeMonth(-1)" style="color:white; background:none; border:none;"><i class="fa-solid fa-chevron-left"></i></button>
                <h3 id="calTitle">2026 年 1 月</h3>
                <button onclick="window.changeMonth(1)" style="color:white; background:none; border:none;"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>
        <div class="calendar-grid" style="margin-top:20px; color:var(--text-sub); margin-bottom:10px;">
            <div style="text-align:center">日</div><div style="text-align:center">一</div><div style="text-align:center">二</div><div style="text-align:center">三</div><div style="text-align:center">四</div><div style="text-align:center">五</div><div style="text-align:center">六</div>
        </div>
        <div id="calGrid" class="calendar-grid"></div>
        <div class="list-title">當日明細</div>
        <div id="calRecordList" class="record-list"></div>
    </div>

    <div id="view-stats" class="view-section">
        <div class="list-title">收支分析</div>
        <div style="margin:20px; background:var(--card-bg); padding:20px; border-radius:20px;">
            <canvas id="balanceChart"></canvas>
        </div>
        <div style="margin:20px; background:var(--card-bg); padding:20px; border-radius:20px;">
            <canvas id="pieChart"></canvas>
        </div>
    </div>

    <div id="view-loans" class="view-section">
        <div class="list-title">貸款與債務</div>
        <div id="loanList" class="record-list"></div>
    </div>

    <div id="view-budget" class="view-section">
        <div class="list-title">預算執行率</div>
        <div id="budgetList" class="record-list"></div>
    </div>

    <div id="view-savings" class="view-section">
        <div class="list-title">儲蓄目標</div>
        <div id="savingsList" class="record-list"></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="window.switchTab('accounting')" id="nav-accounting"><i class="fa-solid fa-wallet"></i>記帳</div>
        <div class="nav-item" onclick="window.switchTab('calendar')" id="nav-calendar"><i class="fa-solid fa-calendar-days"></i>月曆</div>
        <div class="nav-item" onclick="window.switchTab('stats')" id="nav-stats"><i class="fa-solid fa-chart-pie"></i>統計</div>
        <div class="nav-item" onclick="window.switchTab('loans')" id="nav-loans"><i class="fa-solid fa-file-invoice-dollar"></i>貸款</div>
        <div class="nav-item" onclick="window.switchTab('budget')" id="nav-budget"><i class="fa-solid fa-clipboard-check"></i>預算</div>
        <div class="nav-item" onclick="window.switchTab('savings')" id="nav-savings"><i class="fa-solid fa-piggy-bank"></i>儲蓄</div>
    </div>

    <script>
        // === 1. 初始化與數據 ===
        const SUPABASE_URL = 'https://qancoyfytfewnkuxxdat.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_m4TcgyG7R0zP7P4oDBuXIw_CX_ubhL-';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let records = JSON.parse(localStorage.getItem('my_money_data')) || [];
        // 模擬數據（若空則顯示範例）
        let loans = [{title: "車貸", amount: 500000, paid: 120000}, {title: "學貸", amount: 300000, paid: 50000}];
        let budgets = [{cat: "伙食費", limit: 10000}, {cat: "娛樂", limit: 5000}];
        let savings = [{title: "日本旅遊", target: 50000, current: 12000}];

        let currentType = 'expense';
        let currentUser = null;
        let calDate = new Date();
        let selectedDay = new Date().getDate();

        // === 2. 核心渲染函數 ===
        function renderAll() {
            updateSummary();
            renderList();
            renderCalendar();
            renderCharts();
            renderLoans();
            renderBudgets();
            renderSavings();
        }

        function updateSummary() {
            const inc = records.filter(r => r.type === 'income').reduce((s, r) => s + r.amount, 0);
            const exp = records.filter(r => r.type === 'expense').reduce((s, r) => s + r.amount, 0);
            document.getElementById('totalBalance').textContent = (inc - exp).toLocaleString();
            document.getElementById('totalIncome').textContent = '+' + inc.toLocaleString();
            document.getElementById('totalExpense').textContent = '-' + exp.toLocaleString();
        }

        function renderList() {
            const list = document.getElementById('recordList');
            list.innerHTML = '<div class="list-title">最近紀錄 (點擊刪除)</div>';
            records.slice(0, 10).forEach(r => {
                const isExp = r.type === 'expense';
                list.innerHTML += `
                    <div class="record-item" onclick="window.deleteRecord('${r.id}')">
                        <div><strong>${r.category}</strong><br><small style="color:#888">${new Date(r.date).toLocaleDateString()}</small></div>
                        <div style="color:${isExp?'#fb7185':'#34d399'}">${isExp?'-':'+'}${r.amount}</div>
                    </div>`;
            });
        }

        // === 3. 功能模組渲染 ===
        function renderLoans() {
            const list = document.getElementById('loanList');
            list.innerHTML = '';
            loans.forEach(l => {
                const percent = Math.round((l.paid / l.amount) * 100);
                list.innerHTML += `
                    <div class="record-item" style="flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%;">
                            <span>${l.title}</span><span>${percent}%</span>
                        </div>
                        <div class="progress-container" style="width:100%;"><div class="progress-bar" style="width:${percent}%; background:var(--accent-purple)"></div></div>
                        <small style="color:#888">已還 $${l.paid.toLocaleString()} / $${l.amount.toLocaleString()}</small>
                    </div>`;
            });
        }

        function renderBudgets() {
            const list = document.getElementById('budgetList');
            list.innerHTML = '';
            budgets.forEach(b => {
                const spent = records.filter(r => r.category === b.cat && r.type === 'expense').reduce((s, r) => s + r.amount, 0);
                const percent = Math.min(100, Math.round((spent / b.limit) * 100));
                list.innerHTML += `
                    <div class="record-item" style="flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%;">
                            <span>${b.cat}</span><span>${spent}/${b.limit}</span>
                        </div>
                        <div class="progress-container" style="width:100%;"><div class="progress-bar" style="width:${percent}%; background:${percent>90?'#fb7185':'#22d3ee'}"></div></div>
                    </div>`;
            });
        }

        function renderSavings() {
            const list = document.getElementById('savingsList');
            list.innerHTML = '';
            savings.forEach(s => {
                const percent = Math.round((s.current / s.target) * 100);
                list.innerHTML += `
                    <div class="record-item" style="flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%;">
                            <span>${s.title}</span><span>${percent}%</span>
                        </div>
                        <div class="progress-container" style="width:100%;"><div class="progress-bar" style="width:${percent}%; background:var(--accent-gold)"></div></div>
                    </div>`;
            });
        }

        // === 4. 圖表邏輯 ===
        let bChart, pChart;
        function renderCharts() {
            const ctxB = document.getElementById('balanceChart');
            const ctxP = document.getElementById('pieChart');
            if(bChart) bChart.destroy();
            if(pChart) pChart.destroy();

            const expData = records.filter(r => r.type === 'expense').reduce((s, r) => s + r.amount, 0);
            const incData = records.filter(r => r.type === 'income').reduce((s, r) => s + r.amount, 0);

            bChart = new Chart(ctxB, {
                type: 'bar',
                data: { labels: ['收入', '支出'], datasets: [{ data: [incData, expData], backgroundColor: ['#34d399', '#fb7185'] }] },
                options: { plugins: { legend: { display: false } } }
            });

            pChart = new Chart(ctxP, {
                type: 'doughnut',
                data: { labels: ['食', '衣', '住', '行'], datasets: [{ data: [30, 10, 40, 20], backgroundColor: ['#60a5fa', '#a78bfa', '#22d3ee', '#fbbf24'] }] }
            });
        }

        // === 5. 月曆邏輯 ===
        window.changeMonth = (offset) => { calDate.setMonth(calDate.getMonth() + offset); renderCalendar(); };
        window.selectDate = (d) => { selectedDay = d; renderCalendar(); };
        
        function renderCalendar() {
            const year = calDate.getFullYear();
            const month = calDate.getMonth();
            document.getElementById('calTitle').textContent = `${year} 年 ${month + 1} 月`;
            
            const grid = document.getElementById('calGrid');
            grid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month+1, 0).getDate();

            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';
            for(let d=1; d<=daysInMonth; d++) {
                const isSelected = d === selectedDay;
                grid.innerHTML += `<div class="cal-day ${isSelected?'selected':''}" onclick="window.selectDate(${d})">${d}</div>`;
            }
            
            // 當日明細
            const dayRecords = records.filter(r => {
                const dObj = new Date(r.date);
                return dObj.getDate() === selectedDay && dObj.getMonth() === month;
            });
            const calList = document.getElementById('calRecordList');
            calList.innerHTML = dayRecords.length ? '' : '<p style="text-align:center; padding:20px; color:#555;">無紀錄</p>';
            dayRecords.forEach(r => {
                calList.innerHTML += `<div class="record-item"><span>${r.category}</span><span>$${r.amount}</span></div>`;
            });
        }

        // === 6. 互動功能 ===
        window.switchTab = (tab) => {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + tab).classList.add('active');
            document.getElementById('nav-' + tab).classList.add('active');
            if(tab === 'stats') setTimeout(renderCharts, 100);
        };

        window.setType = (t) => {
            currentType = t;
            document.getElementById('typeExp').style.background = t === 'expense' ? 'var(--accent-red)' : '#333';
            document.getElementById('typeInc').style.background = t === 'income' ? 'var(--accent-green)' : '#333';
            renderCategories();
        };

        window.addRecord = async function() {
            const amt = document.getElementById('amountInput').value;
            const cat = document.getElementById('categoryInput').value;
            const date = document.getElementById('dateInput').value;
            if(!amt || !date) return alert("請填寫完整");

            const newRec = { id: Date.now().toString(), type: currentType, amount: parseInt(amt), category: cat, date: new Date(date).toISOString() };
            records.unshift(newRec);
            localStorage.setItem('my_money_data', JSON.stringify(records));
            
            if(currentUser) {
                await _supabase.from('records').insert([{...newRec, user_id: currentUser.id}]);
            }
            
            renderAll();
            showToast("記帳成功");
            document.getElementById('amountInput').value = '';
        };

        window.deleteRecord = function(id) {
            if(!confirm("確定刪除？")) return;
            records = records.filter(r => r.id !== id);
            localStorage.setItem('my_money_data', JSON.stringify(records));
            renderAll();
        };

        window.showToast = (m) => {
            const s = document.getElementById('statusMsg'); s.textContent = m; s.style.opacity = 1;
            setTimeout(() => s.style.opacity = 0, 2000);
        };

        window.openAuthModal = () => document.getElementById('authModal').classList.add('open');
        window.closeModal = (id) => document.getElementById(id).classList.remove('open');

        function renderCategories() {
            const cats = { expense: ["伙食費", "交通", "娛樂", "購物"], income: ["月薪", "投資", "獎金"] };
            const s = document.getElementById('categoryInput');
            s.innerHTML = cats[currentType].map(c => `<option value="${c}">${c}</option>`).join('');
        }

        window.onload = () => {
            renderCategories();
            document.getElementById('dateInput').value = new Date().toISOString().slice(0,16);
            renderAll();
        };

    </script>
</body>
</html>
